---
title: çº¿æ®µæ ‘åˆæ¢
tags:
  - æ•°æ®ç»“æ„
  - æ ‘
categories:
  - æ•°æ®ç»“æ„
date: 2019/12/9
cover: 'https://i.loli.net/2019/12/09/b1LJaFSeGxsTKwn.png'
abbrlink: 44ba5333
---

## å‰è¨€

çº¿æ®µæ ‘å…¶å®å±äºæ¯”è¾ƒé«˜çº§çš„æ•°æ®ç»“æ„äº†ï¼Œæœ¬äººå¹¶ä¸æ˜¯ç«èµ›é€‰æ‰‹ï¼Œè¿™é‡Œçš„ä»£ç ä¹Ÿæ˜¯å€Ÿé‰´çš„ bobo è€å¸ˆçš„è§†é¢‘è¯¾æ¥å®ç°çš„ï¼Œé¢è¯•ä»€ä¹ˆçš„ä¸€èˆ¬æ˜¯ä¸ä¼šè€ƒçš„ï¼Œè¿™é‡Œä¸»è¦æ˜¯å‡ºäºå…´è¶£ç»ƒç»ƒæ‰‹

## é—®é¢˜å¼•å…¥

[307. åŒºåŸŸå’Œæ£€ç´¢ - æ•°ç»„å¯ä¿®æ”¹](https://leetcode-cn.com/problems/range-sum-query-mutable/)

ç»™å®šä¸€ä¸ªæ•´æ•°æ•°ç»„  numsï¼Œæ±‚å‡ºæ•°ç»„ä»ç´¢å¼• i åˆ° j  (i â‰¤ j) èŒƒå›´å†…å…ƒç´ çš„æ€»å’Œï¼ŒåŒ…å« i,  j ä¸¤ç‚¹ã€‚

update(i, val) å‡½æ•°å¯ä»¥é€šè¿‡å°†ä¸‹æ ‡ä¸º i çš„æ•°å€¼æ›´æ–°ä¸º valï¼Œä»è€Œå¯¹æ•°åˆ—è¿›è¡Œä¿®æ”¹ã€‚

**ç¤ºä¾‹ï¼š**

```java
Given nums = [1, 3, 5]

sumRange(0, 2) -> 9
update(1, 2)
sumRange(0, 2) -> 8
```

**è¯´æ˜ï¼š**

1. æ•°ç»„ä»…å¯ä»¥åœ¨ update å‡½æ•°ä¸‹è¿›è¡Œä¿®æ”¹ã€‚
2. ä½ å¯ä»¥å‡è®¾ update å‡½æ•°ä¸ sumRange å‡½æ•°çš„è°ƒç”¨æ¬¡æ•°æ˜¯å‡åŒ€åˆ†å¸ƒçš„ã€‚

> è¿™é¢˜å¦‚æœæ•°ç»„ä¸èƒ½ä¿®æ”¹çš„è¯å°±å¥½è¯´äº†ï¼Œå¯ä»¥ç›´æ¥åˆ©ç”¨æ•°ç»„çš„å‰ç¼€å’Œï¼Œä½†æ˜¯è¿™é‡Œæ•°ç»„æ˜¯ä¼šå˜åŒ–çš„ï¼Œéš¾é“æ²¡æ›´æ–°ä¸€æ¬¡éƒ½è¦é‡æ–°éå†ä¹ˆï¼Ÿé‚£ä¹Ÿå¤ªæ…¢äº†å§ï¼Œæœ‰æ²¡æœ‰ä¸€ç§ç»“æ„èƒ½é«˜æ•ˆçš„æ’å…¥åŒæ—¶ä¹Ÿèƒ½é«˜æ•ˆçš„æŸ¥è¯¢ï¼Ÿ

## çº¿æ®µæ ‘

çº¿æ®µæ ‘ï¼Œå®ƒåœ¨å„ä¸ªèŠ‚ç‚¹ä¿å­˜ä¸€æ¡çº¿æ®µï¼ˆæ•°ç»„ä¸­çš„ä¸€æ®µå­æ•°ç»„ï¼‰ï¼Œä¸»è¦ç”¨äºé«˜æ•ˆè§£å†³è¿ç»­åŒºé—´çš„åŠ¨æ€æŸ¥è¯¢é—®é¢˜ï¼Œç”±äºäºŒå‰ç»“æ„çš„ç‰¹æ€§ï¼ˆå®ƒæ˜¯ä¸€é¢—å¹³è¡¡äºŒå‰æ ‘ï¼‰ï¼Œå®ƒåŸºæœ¬èƒ½ä¿æŒæ¯ä¸ªæ“ä½œçš„å¤æ‚åº¦ä¸º`O(logN)`

çº¿æ®µæ ‘çš„æ¯ä¸ªèŠ‚ç‚¹è¡¨ç¤ºä¸€ä¸ªåŒºé—´ï¼Œçˆ¶åŒºé—´ä¸º`[a,b]` åˆ™å·¦å­åŒºé—´ä¸º`[a,(a+b)/2]`å³å­åŒºé—´ä¸º`[(a+b)/2+1,b]` æœ€åº•å±‚çš„å¶å­èŠ‚ç‚¹å°±æ˜¯å¯¹åº”çš„ä¸€ä¸ªä¸ªå…·ä½“çš„å…ƒç´ å€¼ï¼Œè¿™é‡Œæˆ‘ä»¬é‡‡ç”¨æ•°ç»„æ¥å®ç°çº¿æ®µæ ‘

```java
import java.util.function.*;
public class SegmentTree<E>{
    
    private E[] data;

    private E[] tree;

    private BiFunction<E,E,E> function;

    public SegmentTree(E[] arr,BiFunction<E,E,E> function){
        data = (E[]) new Object[arr.length];
        this.function=function;
        System.arraycopy(arr,0,data,0,arr.length);
        //å€¼å¾—æ€è€ƒä¸ºä»€ä¹ˆæ˜¯ 4n
        tree = (E[]) new Object[4*arr.length];
        buildSegmentTree(0,0,arr.length-1);
    }

    //æ ¹æ®ä¼ å…¥çš„ BiFuction æ„å»ºçº¿æ®µæ ‘
    private void buildSegmentTree(int index,int left,int right){
        if (left==right) {
            tree[index] =data[right];
            return;
        }
        int leftIndex=leftChild(index);
        int rightIndex=rightChild(index);
        int mid=left+(right-left)/2;
        buildSegmentTree(leftIndex,left,mid);
        buildSegmentTree(rightIndex,mid+1,right);
        //æ ¹æ®ä¸šåŠ¡éœ€æ±‚ä¼ å…¥ BiFunction
        tree[index]=function.apply(tree[leftIndex],tree[rightIndex]);
    }

    //èŒƒå›´æœç´¢
    public E searchRange(int left,int right){
        return searchRange(0,0,data.length-1,left,right);
    }

    private E searchRange(int rootIndex,int left,int right,int targetLeft,int targetRight){
        if (targetLeft == left && targetRight == right) {
            return tree[rootIndex];
        }
        int mid=left+(right-left)/2;
        if (targetLeft>mid) {
            return searchRange(rightChild(rootIndex),mid+1,right,targetLeft,targetRight);
        }
        if (targetRight<=mid) {
            return searchRange(leftChild(rootIndex),left,mid,targetLeft,targetRight);
        }
        return function.apply(searchRange(leftChild(rootIndex),left,mid,targetLeft,mid),searchRange(rightChild(rootIndex),mid+1,right,mid+1,targetRight));
    }

    public void update(int index,E e){
        if (index<0 || index>=data.length) {
            throw new IllegalArgumentException("index illegal");
        }
        update(0,0,data.length-1,index,e);
    }

    public void update(int rootIndex,int left,int right,int targetIndex,E e){
        if (left == right) {
            tree[rootIndex]=e;
            return;
        }
        int mid=left+(right-left)/2;
        if (targetIndex<=mid) {
            update(leftChild(rootIndex),left,mid,targetIndex,e);
        }else{
            update(rightChild(rootIndex),mid+1,right,targetIndex,e);
        }
        tree[rootIndex]=function.apply(tree[leftChild(rootIndex)],tree[rightChild(rootIndex)]);
    }

    public int getSize(){
        return data.length;
    }

    public E get(int index){
        if (index<0 || index>=data.length) {
            throw new IllegalArgumentException("index is illegal!");
        }
        return data[index];
    }

    //å·¦å­©å­
    private int leftChild(int index){
        return index*2+1;
    }

    //å³å­©å­
    private int rightChild(int index){
        return index*2+2;
    }
}
```

æ²¡å•¥å¥½è¯´çš„ï¼Œæ•´ä½“è¿˜æ˜¯æŒºç®€å•çš„ï¼Œä»£ç ä¸­ç”¨åˆ°äº† Java8 çš„å‡½æ•°å¼æ¥å£ï¼Œç¡®å®æŒºæ–¹ä¾¿çš„

å…¶å®æˆ‘è§‰å¾—æœ‰ä¸€ä¸ªæ¯”è¾ƒå…³é”®çš„ç‚¹å°±æ˜¯çº¿æ®µæ ‘éœ€è¦å¤šå¤§çš„æ•°ç»„ç©ºé—´ï¼Ÿ

é¦–å…ˆä¸€é¢— H å±‚ï¼ˆH ä» 1 å¼€å§‹ï¼‰çš„æ»¡äºŒå‰æ ‘ä¸€å…±æœ‰ `2^H-1`  ä¸ªèŠ‚ç‚¹ï¼Œæˆ‘ä»¬å¿½ç•¥é‚£ä¸€ä¸ªèŠ‚ç‚¹ï¼Œçº¦ä¸º`2^H`ä¸ªèŠ‚ç‚¹ï¼Œè€Œæœ€åä¸€å±‚ï¼ˆh-1 å±‚ï¼‰æœ‰ `2^(h-1)`ä¸ªèŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯è¯´æœ€åä¸€å±‚çš„èŠ‚ç‚¹æ ‘å¤§è‡´ç­‰äºå‰é¢æ‰€æœ‰å±‚èŠ‚ç‚¹çš„å’Œï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å¾—å‡ºä¸€ä¸ªç»“è®ºï¼Œåœ¨çº¿æ®µæ ‘ä¸­å¦‚æœéœ€è¦è¡¨ç¤ºçš„åŒºé—´å¤§å°ä¸º nï¼Œå¹¶ä¸” n åˆšå¥½ç­‰äº 2 çš„ k æ¬¡å¹‚çš„è¯ï¼ˆä¹Ÿå°±æ˜¯æ”¾å¥½æ„æˆä¸€é¢—æ»¡äºŒå‰æ ‘ï¼‰ï¼Œé‚£ä¹ˆå°±åªéœ€è¦ 2n çš„èŠ‚ç‚¹ä¸ªæ•°ï¼Œä½†æ˜¯å¦‚æœæ˜¯`n=2^k+c` é‚£ä¹ˆå½“å‰å±‚å°±å­˜ä¸ä¸‹è¿™ n ä¸ªå…ƒç´ ï¼Œéœ€è¦å­˜åˆ°ä¸‹ä¸€å±‚ï¼Œä¹Ÿå°±æ˜¯ç©ºé—´è¿˜éœ€è¦* 2ï¼Œæ‰€ä»¥æœ€åæˆ‘ä»¬å°±éœ€è¦ 4n çš„ç©ºé—´å»å­˜å‚¨è¿™é¢—çº¿æ®µæ ‘ã€‚

è¿™ä¸ªæ—¶å€™å†å›å¤´å»åšä¸Šé¢çš„é¢˜å°±ä¼šå¾ˆç®€å•äº†ğŸ˜

> çº¿æ®µæ ‘å…¶å®è¿˜æœ‰å¾ˆå¤šçš„æ‰©å±•ï¼Œä¸Šé¢çš„æ˜¯æœ€æœ€æœ€åŸºæœ¬çš„æœ€ç®€å•çš„çº¿æ®µæ ‘ç»“æ„ï¼Œæˆ‘è¿˜æ ¹æœ¬å°±æ²¡æ‘¸åˆ°çº¿æ®µæ ‘çš„é—¨ğŸ˜‚ï¼Œåªæ˜¯çŸ¥é“äº†æœ‰è¿™ä¹ˆä¸ªç»“æ„
>
> ç”±äºæˆ‘å®åœ¨æ˜¯å¤ªèœäº†ï¼Œä¹Ÿæ²¡æœ‰æ—¶é—´å»äº†è§£é‚£äº›ç»“æ„äº†
>
> å½“ç„¶é¢è¯•çš„æ—¶å€™å¹¶ä¸ä¼šè€ƒçº¿æ®µæ ‘è¿™äº›ç©æ„å„¿ï¼Œæˆ‘ä¹Ÿåªæ˜¯ä¸ºäº†ç»ƒç»ƒæ‰‹ï¼ŒçœŸæ­£çš„ç«èµ›çš„é¢˜ç›®ä¹Ÿä¸ä¼šåƒä¸Šé¢é‚£ä¹ˆç®€å•ï¼Œäº†è§£å³å¯ğŸ˜…
